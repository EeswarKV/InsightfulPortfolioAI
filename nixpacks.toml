# Railway deployment configuration
[variables]
NIXPACKS_PYTHON_VERSION = "3.12"

[phases.setup]
# stdenv.cc.cc.lib provides libstdc++.so.6 required by numpy 2.x
nixPkgs = ["python312", "stdenv.cc.cc.lib"]

[phases.install]
cmds = [
    "python -m venv /opt/venv",
    "cd apps/api && /opt/venv/bin/pip install --upgrade pip setuptools wheel",
    "cd apps/api && /opt/venv/bin/pip install -e ."
]

[phases.build]
cmds = []

[start]
# Dynamically locate libstdc++.so.6 in the Nix store and add it to LD_LIBRARY_PATH
# before uvicorn starts (numpy 2.x requires it at runtime)
cmd = "bash -c 'GCC_LIB=$(find /nix/store -name libstdc++.so.6 2>/dev/null | grep -v python | head -1 | xargs dirname 2>/dev/null); export LD_LIBRARY_PATH=$GCC_LIB:$LD_LIBRARY_PATH; cd apps/api && /opt/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port $PORT'"
